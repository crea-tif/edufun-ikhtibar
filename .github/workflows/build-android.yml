name: APK Android (debug)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Java 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17

      # 1) Préparer les assets web
      - name: Prepare web assets
        working-directory: android
        run: |
          set -euxo pipefail
          mkdir -p app/src/main/assets/www
          rm -rf app/src/main/assets/www/*
          rsync -av --delete ../docs/ app/src/main/assets/www/

      # 2) Si le wrapper n'existe pas, le créer avec Gradle 8.7
      - name: Ensure Gradle wrapper (8.7)
        working-directory: android
        run: |
          set -euxo pipefail
          if [ ! -x "./gradlew" ]; then
            echo "Wrapper absent -> génération"
            gradle wrapper --gradle-version 8.7
          fi
          chmod +x ./gradlew

      - name: Show Gradle/AGP versions
        working-directory: android
        run: |
          set -euxo pipefail
          ./gradlew --version
          echo "settings.gradle:"
          head -n 50 settings.gradle || true
          echo "root build.gradle:"
          head -n 120 build.gradle || true
          echo "app/build.gradle:"
          head -n 200 app/build.gradle || true

      # 3) Build + logs détaillés + upload systématique du log
      - name: Build debug APK (stacktrace + info)
        working-directory: android
        run: |
          set -euxo pipefail
          ./gradlew :app:assembleDebug --stacktrace --info | tee ../gradle-build.log
        continue-on-error: true

      # 4) Uploader APK si présent
      - name: Upload APK
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: apk-or-logs
          path: |
            android/app/build/outputs/apk/debug/app-debug.apk
            gradle-build.log
          if-no-files-found: warn
